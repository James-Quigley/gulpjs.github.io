<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Make Stream from Buffer · gulp.js</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="# Make stream from buffer (memory contents)"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Make Stream from Buffer · gulp.js"/><meta property="og:type" content="website"/><meta property="og:url" content="https://gulpjs.com//index.html"/><meta property="og:description" content="# Make stream from buffer (memory contents)"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow-night.min.css"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-128126650-1"></script><script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments); }
              gtag('js', new Date());
              gtag('config', 'UA-128126650-1');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/css/main.css"/></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/gulp.svg" alt="gulp.js"/></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/en/getting-started/quick-start" target="_self">Getting Started</a></li><li class=""><a href="/docs/en/api/concepts" target="_self">API</a></li><li class=""><a href="https://gulpjs.com/plugins" target="_self">Plugins</a></li><li class=""><a href="https://twitter.com/gulpjs" target="_self">Twitter</a></li><li class=""><a href="https://github.com/gulpjs/gulp/blob/master/CONTRIBUTING.md" target="_self">Contribute</a></li><li class=""><a target="_self"></a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docMainContainer"><div class="wrapper"><div class="post"><header class="postHeader"></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="make-stream-from-buffer-memory-contents"></a><a href="#make-stream-from-buffer-memory-contents" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Make stream from buffer (memory contents)</h1>
<p>Sometimes you may need to start a stream with files that their contents are in a variable and not in a physical file. In other words, how to start a 'gulp' stream without using <code>gulp.src()</code>.</p>
<p>Let's say for example that we have a directory with js lib files and another directory with versions of some module. The target of the build would be to create one js file for each version, containing all the libs and the version of the module concatenated.</p>
<p>Logically we would break it down like this:</p>
<ul>
<li>load the lib files</li>
<li>concatenate the lib file contents</li>
<li>load the versions files</li>
<li>for each version file, concatenate the libs' contents and the version file contents</li>
<li>for each version file, output the result in a file</li>
</ul>
<p>Imagine this file structure:</p>
<pre><code class="hljs css language-sh">├── libs
│   ├── lib1.js
│   └── lib2.js
└── versions
    ├── version.1.js
    └── version.2.js
</code></pre>
<p>You should get:</p>
<pre><code class="hljs css language-sh">└── output
    ├── version.1.complete.js <span class="hljs-comment"># lib1.js + lib2.js + version.1.js</span>
    └── version.2.complete.js <span class="hljs-comment"># lib1.js + lib2.js + version.2.js</span>
</code></pre>
<p>A simple and modular way to do this would be the following:</p>
<pre><code class="hljs css language-js"><span class="hljs-keyword">var</span> gulp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp'</span>);
<span class="hljs-keyword">var</span> source = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vinyl-source-stream'</span>);
<span class="hljs-keyword">var</span> vinylBuffer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vinyl-buffer'</span>);
<span class="hljs-keyword">var</span> tap = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-tap'</span>);
<span class="hljs-keyword">var</span> concat = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-concat'</span>);
<span class="hljs-keyword">var</span> size = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-size'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> es = <span class="hljs-built_in">require</span>(<span class="hljs-string">'event-stream'</span>);

<span class="hljs-keyword">var</span> memory = {}; <span class="hljs-comment">// we'll keep our assets in memory</span>

<span class="hljs-comment">// task of loading the files' contents in memory</span>
gulp.task(<span class="hljs-string">'load-lib-files'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">// read the lib files from the disk</span>
  <span class="hljs-keyword">return</span> gulp.src(<span class="hljs-string">'src/libs/*.js'</span>)
    <span class="hljs-comment">// concatenate all lib files into one</span>
    .pipe(concat(<span class="hljs-string">'libs.concat.js'</span>))
    <span class="hljs-comment">// tap into the stream to get each file's data</span>
    .pipe(tap(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file</span>) </span>{
      <span class="hljs-comment">// save the file contents in memory</span>
      memory[path.basename(file.path)] = file.contents.toString();
    }));
});

gulp.task(<span class="hljs-string">'load-versions'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  memory.versions = {};
  <span class="hljs-comment">// read the version files from the disk</span>
  <span class="hljs-keyword">return</span> gulp.src(<span class="hljs-string">'src/versions/version.*.js'</span>)
  <span class="hljs-comment">// tap into the stream to get each file's data</span>
  .pipe( tap(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">file</span>) </span>{
    <span class="hljs-comment">// save the file contents in the assets</span>
    memory.versions[path.basename(file.path)] = file.contents.toString();
  }));
});

gulp.task(<span class="hljs-string">'write-versions'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">// we store all the different version file names in an array</span>
  <span class="hljs-keyword">var</span> availableVersions = <span class="hljs-built_in">Object</span>.keys(memory.versions);
  <span class="hljs-comment">// we make an array to store all the stream promises</span>
  <span class="hljs-keyword">var</span> streams = [];

  availableVersions.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">v</span>) </span>{
    <span class="hljs-comment">// make a new stream with fake file name</span>
    <span class="hljs-keyword">var</span> stream = source(<span class="hljs-string">'final.'</span> + v);

    <span class="hljs-keyword">var</span> streamEnd = stream;

    <span class="hljs-comment">// we load the data from the concatenated libs</span>
    <span class="hljs-keyword">var</span> fileContents = memory[<span class="hljs-string">'libs.concat.js'</span>] +
      <span class="hljs-comment">// we add the version's data</span>
      <span class="hljs-string">'\n'</span> + memory.versions[v];

    <span class="hljs-comment">// write the file contents to the stream</span>
    stream.write(fileContents);

    process.nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-comment">// in the next process cycle, end the stream</span>
      stream.end();
    });

    streamEnd = streamEnd
    <span class="hljs-comment">// transform the raw data into the stream, into a vinyl object/file</span>
    .pipe(vinylBuffer())
    <span class="hljs-comment">//.pipe(tap(function(file) { /* do something with the file contents here */ }))</span>
    .pipe(gulp.dest(<span class="hljs-string">'output'</span>));

    <span class="hljs-comment">// add the end of the stream, otherwise the task would finish before all the processing</span>
    <span class="hljs-comment">// is done</span>
    streams.push(streamEnd);

  });

  <span class="hljs-keyword">return</span> es.merge.apply(<span class="hljs-keyword">this</span>, streams);
});

<span class="hljs-comment">//============================================ our main task</span>
gulp.task(<span class="hljs-string">'default'</span>, gulp.series(
    <span class="hljs-comment">// load the files in parallel</span>
    gulp.parallel(<span class="hljs-string">'load-lib-files'</span>, <span class="hljs-string">'load-versions'</span>),
    <span class="hljs-comment">// ready to write once all resources are in memory</span>
    <span class="hljs-string">'write-versions'</span>
  )
);

<span class="hljs-comment">//============================================ our watcher task</span>
<span class="hljs-comment">// only watch after having run 'default' once so that all resources</span>
<span class="hljs-comment">// are already in memory</span>
gulp.task(<span class="hljs-string">'watch'</span>, gulp.series(
  <span class="hljs-string">'default'</span>,
  <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    gulp.watch(<span class="hljs-string">'./src/libs/*.js'</span>, gulp.series(
      <span class="hljs-string">'load-lib-files'</span>,
      <span class="hljs-string">'write-versions'</span>
    ));

    gulp.watch(<span class="hljs-string">'./src/versions/*.js'</span>, gulp.series(
      <span class="hljs-string">'load-lib-files'</span>,
      <span class="hljs-string">'write-versions'</span>
    ));
  }
));
</code></pre>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav docOnPageNav"></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/gulp.svg" alt="gulp.js" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/en/getting-started/quick-start">Getting Started</a><a href="/docs/en/api/concepts">API Reference</a></div><div><h5>Community</h5><a href="https://stackoverflow.com/questions/tagged/gulp" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://twitter.com/gulpjs" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="https://github.com/gulpjs/gulp">GitHub</a><a class="github-button" href="https://github.com/gulpjs/gulp" data-icon="octicon-star" data-count-href="/gulpjs/gulp/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><section class="copyright">Copyright © 2018 GulpJS</section></footer></div></body></html>